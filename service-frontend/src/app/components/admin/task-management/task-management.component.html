<div class="task-management-container">
  <!-- Header -->
  <div class="header-section">
    <h2>Gestion des Tâches</h2>
    <div class="header-actions">
      <button mat-raised-button color="primary" routerLink="/admin/tasks/new">
        <mat-icon>add</mat-icon>
        Nouvelle Tâche
      </button>
      <button mat-stroked-button (click)="exportTasks()">
        <mat-icon>download</mat-icon>
        Exporter
      </button>
      <button mat-stroked-button (click)="refreshData()" [disabled]="loading">
        <mat-icon>refresh</mat-icon>
        Actualiser
      </button>
    </div>
  </div>

  <!-- Statistics -->
  <div class="stats-section">
    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-content">
          <mat-icon>assignment</mat-icon>
          <div class="stat-info">
            <span class="stat-number">{{stats.totalTasks}}</span>
            <span class="stat-label">Tâches</span>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-content">
          <mat-icon>business</mat-icon>
          <div class="stat-info">
            <span class="stat-number">{{stats.totalServices}}</span>
            <span class="stat-label">Services</span>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-content">
          <mat-icon>euro</mat-icon>
          <div class="stat-info">
            <span class="stat-number">{{formatPrice(stats.averagePrice)}}</span>
            <span class="stat-label">Prix moyen</span>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-content">
          <mat-icon>schedule</mat-icon>
          <div class="stat-info">
            <span class="stat-number">{{formatDuration(stats.averageDuration)}}</span>
            <span class="stat-label">Durée moyenne</span>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Filtres -->
  <mat-card class="filters-card">
    <mat-card-content>
      <div class="filters-row">
        <mat-form-field appearance="outline" class="search-field">
          <mat-label>Rechercher une tâche</mat-label>
          <input matInput 
                 [(ngModel)]="searchKeyword" 
                 (input)="onSearchChange()"
                 placeholder="Nom ou description...">
          <mat-icon matSuffix>search</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline" class="service-filter">
          <mat-label>Filtrer par service</mat-label>
          <mat-select [(value)]="selectedServiceId" (selectionChange)="onServiceFilterChange()">
            <mat-option [value]="null">Tous les services</mat-option>
            <mat-option *ngFor="let service of services" [value]="service.id">
              {{service.name}}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <button mat-stroked-button (click)="clearFilters()" class="clear-filters-btn">
          <mat-icon>clear</mat-icon>
          Effacer les filtres
        </button>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Statistiques -->
  <div class="stats-row">
    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-number">{{tasks.length}}</div>
        <div class="stat-label">Total Tâches</div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-number">{{filteredTasks.length}}</div>
        <div class="stat-label">Tâches Affichées</div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-number">{{services.length}}</div>
        <div class="stat-label">Services Actifs</div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Table des tâches -->
  <mat-card class="table-card">
    <mat-card-content>
      <table mat-table [dataSource]="paginatedTasks" class="tasks-table">
        
        <!-- Colonne Image -->
        <ng-container matColumnDef="image">
          <th mat-header-cell *matHeaderCellDef>Image</th>
          <td mat-cell *matCellDef="let task">
            <img [src]="getImageUrl(task.imageName)" 
                 alt="{{task.name}}" 
                 class="task-image">
          </td>
        </ng-container>

        <!-- Colonne Nom -->
        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef>Nom</th>
          <td mat-cell *matCellDef="let task">
            <div class="task-name">{{task.name}}</div>
            <div class="task-description" *ngIf="task.description">
              {{task.description | slice:0:50}}{{task.description.length > 50 ? '...' : ''}}
            </div>
          </td>
        </ng-container>

        <!-- Colonne Service -->
        <ng-container matColumnDef="service">
          <th mat-header-cell *matHeaderCellDef>Service</th>
          <td mat-cell *matCellDef="let task">
            <mat-chip class="service-chip">{{getServiceName(task.serviceId)}}</mat-chip>
          </td>
        </ng-container>

        <!-- Colonne Durée -->
        <ng-container matColumnDef="duration">
          <th mat-header-cell *matHeaderCellDef>Durée</th>
          <td mat-cell *matCellDef="let task">
            <div class="duration-badge">
              <mat-icon>schedule</mat-icon>
              {{task.duration}} min
            </div>
          </td>
        </ng-container>

        <!-- Colonne Prix -->
        <ng-container matColumnDef="price">
          <th mat-header-cell *matHeaderCellDef>Prix</th>
          <td mat-cell *matCellDef="let task">
            <div class="price-badge">{{getTaskPrice(task)}}</div>
          </td>
        </ng-container>

        <!-- Colonne Matériaux -->
        <ng-container matColumnDef="materials">
          <th mat-header-cell *matHeaderCellDef>Matériaux</th>
          <td mat-cell *matCellDef="let task">
            <div class="materials-count" *ngIf="getMaterialsCount(task) > 0">
              <mat-icon>build</mat-icon>
              {{getMaterialsCount(task)}} matériaux
            </div>
            <div class="no-materials" *ngIf="getMaterialsCount(task) === 0">
              Aucun matériau
            </div>
          </td>
        </ng-container>

        <!-- Colonne Actions -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let task">
            <div class="action-buttons">
              <button mat-icon-button 
                      color="primary" 
                      (click)="viewTaskDetails(task)"
                      matTooltip="Voir détails">
                <mat-icon>visibility</mat-icon>
              </button>
              
              <button mat-icon-button 
                      color="accent" 
                      (click)="editTask(task)"
                      matTooltip="Modifier">
                <mat-icon>edit</mat-icon>
              </button>
              
              <button mat-icon-button 
                      (click)="duplicateTask(task)"
                      matTooltip="Dupliquer">
                <mat-icon>content_copy</mat-icon>
              </button>
              
              <button mat-icon-button 
                      color="warn" 
                      (click)="deleteTask(task)"
                      matTooltip="Supprimer">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
      </table>

      <!-- Message si aucune tâche -->
      <div class="no-tasks" *ngIf="filteredTasks.length === 0">
        <mat-icon>assignment</mat-icon>
        <p>Aucune tâche trouvée</p>
        <button mat-raised-button color="primary" routerLink="/admin/tasks/new">
          Créer la première tâche
        </button>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Pagination -->
  <app-pagination 
    *ngIf="filteredTasks.length > 0"
    [config]="paginationConfig"
    (pageChange)="onPageChange($event)"
    (pageSizeChange)="onPageSizeChange($event)">
  </app-pagination>

  <!-- Indicateur de chargement -->
  <div class="loading-overlay" *ngIf="loading">
    <mat-spinner></mat-spinner>
    <p>Chargement des tâches...</p>
  </div>

</div>
